#### 刷机准备

- 建议下载好固件后，对固件的md5/sha1校验码进行核对，以保证固件完整性；
- 建议刷机全程使用电脑端谷歌Chrome，或者Chromium内核的浏览器进行操作；
- 如果使用了USB2JFFS插件，建议先使用卸载掉USB的挂载后在进行刷机，刷机后再进行挂载。

#### 固件定义

- `原厂固件`为GT-AX6000华硕官方固件：[GT-AX6000华硕官方固件下载地址](https://www.asus.com.cn/networking-iot-servers/wifi-routers/asus-gaming-routers/GT-AX6000/HelpDesk_Download/)；
- `官改固件`为KoolCenter开发组在此贴：[https://www.koolcenter.com/posts/135](https://www.koolcenter.com/posts/135)发布的基于华硕官方GT-AX6000 386源代码修改而来的带软件中心的GT-AX6000官改固件，版本号为官方固件版本号后加上`_koolshare`后缀，如GT-AX6000官改固件版本：`3.0.0.4.386_46061_koolshare`。
- `原版梅林固件`为加拿大独立开发者Eric Sauvageau在华硕GT-AX6000官方源码上二次开发的第三方固件，相较华硕官方固件，其区别为：[这些功能](https://github.com/RMerl/asuswrt-merlin.ng/blob/master/README-merlin.txt#L62-L132)，其版本号为`386.x_y`，如：`386.6_0`；
- `改版梅林固件`为koolshare开发组在本贴发布的基于梅林固件源码再次开发而来的带软件中心的GT-AX6000梅林改版固件，其版本号和梅林原版固件保持一致，如GT-AX6000梅林改版固件版本：`386.6_0`。

#### 刷机术语

> 为消除小白在刷机过程中的疑惑，下面列出一下华硕/梅林固件刷机的基本术语及我自己的解释，希望对大家有所帮助。如果你对下面的内容已经比较清楚，那么可以跳过这部分直接进入到刷机流程。

1. **固件双清**：双清就是要清除：1. nvram配置，2：JFFS分区文件。固件的很多设置都是储存在nvram中，例如拨号方式、拨号上网帐号密码、无线网络设置等；固件的很多文件是储存在JFFS分区的，例如流量分析储存的流量数据，SSL证书，UU加速器程序等。一般同类型固件互刷不需要进行双清，不同类型固件互刷视情况要进行双清，以保证路由器刷机后处于最佳工作状态。

   如何双清路由器：进入【系统管理 】–【 恢复/导出/上传设置】，勾选恢复按钮旁的选择框，然后点击恢复按钮。

2. **恢复出厂**：恢复出厂就是清除固件的nvram配置，但是不清除JFFS分区文件。这样流量分析、SSL证书等文件并不会丢失。值得注意的是很多朋友有用【导出设置】来备份固件配置的习惯，而在刷固件，特别是不同类型固件互刷的情况下，是不适用使用备份的配置来恢复刚刚进行了恢复出厂的机器的，因为这样就相当于你什么也没恢复。所以请一定不要使用以前备份的配置来恢复刚刷机后，又进行过恢复出厂的路由器。使用【导出设置】备份的配置文件，一般进行了一些设置导致路由器出了问题，将路由器恢复到原厂默认值后，再用备份配置进行恢复，使用备份配置前后，路由器都是同一个版本。

   如何恢复出厂：进入【系统管理 】–【 恢复/导出/上传设置】，点击恢复按钮，记住不要勾选恢复按钮右侧的选择框！！

3. **格式化JFFS**：格式化JFFS就是对JFFS分区进行格式化，这样会删除JFFS分区中储存的所有文件，而不影响路由器的其它配置。在GT-AX6600和XT12这类新平台机器上，梅林固件已经取消了格式化jffs分区的选项，因为现在固件jffs分区默认采用了UBIFS格式，且默认开启此分区的挂载，所以不需要进行格式化了。

4. **JFFS挂载状态**：通过SSH连接到路由器后台后输入命令（如果不知道如何使用SSH执行命令，可以参考下文【重要命令】中的【如何使用SSH】）：`mount | grep -w /jffs`，如果看到类似`ubi:jffs2 on /jffs type ubifs (rw,relatime,assert=read-only,ubi=0,vol=13)`这样的输出，说明/jffs成功挂载了，挂载设备为`ubi:jffs2`。当然，在梅林/梅林改版固件中，只需要进入【Tools - Sysinfo】页面，在JFFS一栏即可看到JFFS挂载状态，如果成功挂载，将会显示JFFS已用容量和总容量，如果没有挂在，则会显示*umounted*字样。因为软件中心是储存在JFFS中的，所以如果软件中心进入后是空白页面，一般来说JFFS分区的挂载就出现了问题。遇到这种情况，可以参考下文FAQ中的【Q4：刷机后软件中心一片空白】来尝试解决。

5. **JFFS分区备份/还原**：使用梅林/梅林改版固件的朋友，可能知道梅林固件相对于华硕官方固件，多了JFFS分区备份/还原功能，其本质就是将JFFS分区内的所有文件进行打包，然后在需要的时候进行还原。此功能在某些时候会特别管用，比如某个版本固件升级后，JFFS分区容量被缩小了，这会导致储存在JFFS分区靠后的文件块被强行清除，从而导致JFFS分区内文件丢失、文件损坏。而使用JFFS分区备份/还原功能，在每次固件升级前先备份一次JFFS分区内容，在固件升级后，如果JFFS分区内容出现丢失、损坏等，再用备份进行还原即可规避上面的问题。当然如果是梅林改版固件的话，只进行还原还是不够的，因为刚还原后，软件中心相关程序虽然还原了，但是其进程还没有启动，此时重启一次路由器，才能让软件中心在还原后正常工作。

#### 开始刷机

因为救援模式的存在，所以华硕路由器刷机是刷不死的，只要刷机过程中有灯亮，那么出现任何无法启动的问题都是能救得活的。所以不论你当前处在什么类型固件、什么固件版本下，都可以尝试一步刷到位：直接刷机到最新的`386改版梅林`固件！如果能正常通过刷机，成功后进行一次固件双清，达到干净刷机的效果。如果不能通过刷机，救援模式也是分分钟能搞定的事情！所以请不要被下面写得非常详细的刷机流程吓到。

当然，也可以将刷机做到很细致，那么根据你现在的固件，用下面A - F的操作来对号入座把！虽然细致刷机过程也可能发生意外，但是请记住三大法宝：重启、重置、救援模式。

#### A. 原厂固件 → 改版梅林固件：

> 原厂固件和原版梅林固件/改版梅林固件在一些默认配置上有所不同，虽然刷机后不用恢复出厂设置也能正常工作，但是建议有时间朋友刷机完成后双清一次路由双清后全部手动配置，且双清后不要用以前的备份配置来恢复。

1. 在原厂固件固件升级页面下直接上传.w 后缀的改版梅林固件文件；
2. 成功上传固件后，路由器会自动重启，此时刷机完成（刷机完成后可以不恢复出产设置，当然恢复一次更好）；
3. 刷机完成在【系统管理 】–【 系统设置】内勾选`Enable JFFS custom scripts and configs` 然后点击`应用本页面设置`；
4. 继续设置路由器，将路由器连上网络，然后进入软件中心，如果软件中心一片空白，不要着急，先软重启（使用顶部重启按钮）一次路由器即可出现软件中心，如果软件中心仍然空白，参见FAQ：Q4的解决办法。
5. 如果进入软件中心后正常，将软件中心更新到最新版本（如果有）后即完成全部刷机，之后你可以对路由器固件进行其它喜好的设置，或者在软件中心安装插件等操作。

#### B. 原版梅林固件 → 改版梅林固件：

> 原版梅林固件和改版梅林固件在固件配置上完全相同，所以刷机后不需要进行双清操作也能正常工作。但是如果你是从官方固件 → 原版梅林固件 → 改版梅林固件，且官方固件 → 原版梅林固件过程中没有双清，那么还是建议进行一次路由器双清操作。

1. 在`原版梅林固件`固件升级页面下直接上传.w 后缀的`改版梅林固件`文件；
2. 成功上传固件后，路由器会自动重启，此时刷机完成（刷机完成后可以不恢复出产设置，当然恢复一次更好）；
3. 刷机完成在【系统管理 】–【 系统设置】内勾选`Enable JFFS custom scripts and configs` 然后点击`应用本页面设置`；
4. 继续设置路由器，将路由器连上网络，然后进入软件中心，如果软件中心一片空白，不要着急，先软重启（使用顶部重启按钮）一次路由器即可出现软件中心，如果软件中心仍然空白，参见FAQ：Q4的解决办法。
5. 如果进入软件中心后正常，将软件中心更新到最新版本（如果有）后即完成全部刷机，之后你可以对路由器固件进行其它喜好的设置，或者在软件中心安装插件等操作。

#### C. 官改固件 → 改版梅林固件：

> - 官改固件和原版梅林固件/改版梅林固件在一些默认配置上有所不同，虽然刷机后不用恢复出厂设置也能正常工作，但是建议有时间朋友刷机完成后双清一次路由双清后全部手动配置，不要用以前的备份配置。
> - 目前某些情况下，官改固件刷改版梅林固件后，出现jffs2_scripts无法勾选（勾选后应用还是会变成未勾选），那就必须进行恢复出厂设置！
> - 固件双清不仅会清除路由器所有配置，还会删除JFFS分区得所有内容，包括软件中心，如果你希望在官改固件刷到改版梅林固件后，软件中心和所有插件得到保留，你可以使用USB2JFFS插件，用USB磁盘来替代JFFS分区。刷机前在USB2JFFS插件内点击卸载 → 然后刷机 → 双清路由器 → 进入到新系统并完成软件中心初始化后 → 安装USB2JFFS插件 → 点击挂载 → 重启路由器。

1. 在`官改固件`固件升级页面下直接上传.w 后缀的`改版梅林固件`文件；
2. 成功上传固件后，路由器会自动重启，此时刷机完成；
3. 刷机完成后对路由器进行一次`双清`，并全部手动配置路由器；
4. 刷机完成在【系统管理 】–【 系统设置】内勾选`Enable JFFS custom scripts and configs` 然后点击`应用本页面设置`；
5. 继续设置路由器，将路由器连上网络，然后进入软件中心，如果软件中心一片空白，不要着急，先软重启（使用顶部重启按钮）一次路由器即可出现软件中心，如果软件中心仍然空白，参见FAQ：Q4的解决办法。
6. 如果进入软件中心后正常，将软件中心更新到最新版本（如果有）后即完成全部刷机，之后你可以对路由器固件进行其它喜好的设置，或者在软件中心安装插件等操作。

#### D. 改版梅林固件 → 改版梅林固件、

> 常见于系统升级，比如梅林改版固件386.4_0升级到386.5_2，一般来说如果新固件没有特别说明，都是不需要双清操作的。

1. 在改版梅林固件升级页面下直接上传.w 后缀的改版梅林固件文件，刷机完成后机器会自动重启；
2. 请阅读你刷的固件版本的更新日志，看是否有附加刷机说明（如恢复出厂，双清，格式化JFFS等），如果没有任何要求，刷机完成后可以不恢复出厂设置；
3. 刷机完成后，固件中的软件中心和所有插件都会得到保留；
4. 以上步骤完成后，固件中的软件中心和所有插件都会得到保留；
5. 如果刷机后软件中心页面一片空白，建议再手动软重启（使用顶部重启按钮）一次路由器，如果仍然空白，参见FAQ：Q4。

#### E. 改版梅林固件 → 官改固件

> 原版梅林固件/改版梅林固件与官改固件在一些默认配置上有所不同，虽然刷机后不用恢复出厂设置也能正常工作，但是建议有时间朋友刷机完成后双清一次路由，双清后全部手动配置，不要用以前的备份配置。
>
> 固件双清不仅会清除路由器所有配置，还会删除JFFS分区得所有内容，包括软件中心，如果你希望在官改固件刷到改版梅林固件后，软件中心和所有插件得到保留，你可以使用USB2JFFS插件，用USB磁盘来替代JFFS分区。刷机前在USB2JFFS插件内点击卸载 → 然后刷机 → 双清路由器 → 进入到新系统并完成软件中心初始化后 → 安装USB2JFFS插件 → 点击挂载 → 重启路由器。

1. 在`改版梅林固件`固件升级页面下直接上传.w 后缀的`官改固件`文件；
2. 成功上传固件后，路由器会自动重启，此时刷机完成；
3. 刷机完成后对路由器进行一次`双清`，并全部手动配置路由器；
4. 双清完成后进入路由器web后台，将路由器连上网络，然后进入软件中心，如果软件中心一片空白，不要着急，先软重启（使用顶部重启按钮）一次路由器即可出现软件中心，如果软件中心仍然空白，参见FAQ：Q4的解决办法。
5. 如果进入软件中心后正常，将软件中心更新到最新版本（如果有）后即完成全部刷机，之后你可以对路由器固件进行其它喜好的设置，或者在软件中心安装插件等操作。

#### F. 改版梅林固件 → 原厂固件/原版梅林固件

> 从改版梅林固件刷为原厂固件/原版梅林固件后建议做一次双清操作，以清除jffs分区里残留的一些软件中心相关文件。不过即使不进行双清操作，也不会影响刷回原厂固件路由器的正常工作，你甚至可以立即再刷回改版梅林固件，软件中心的所有插件和配置都将得到保留，并且正常工作。

1. 在`改版梅林固件`升级页面下直接上传.w 后缀的`原厂固件`/`原版梅林固件`文件；
2. 成功上传固件后，路由器会自动重启，此时刷机完成；
3. 刷机完成后固件恢复为官方固件，但是jffs分区可能仍然留有一些软件中心相关文件；
4. 如需彻底清空jffs里的文件残留，需要再执行一次双清操作；
5. 如果不想双清后重新设置路由器，可以参见后文【重要命令】中的【清空jffs空间】或者【删除软件中心】。


### 六、注意事项

1. 刷机后如果界面显示不正常，请使用组合键`ctrl + F5`强制清空浏览器缓存后重试；
2. 强烈建议使用chrome浏览器或者chromium内核的浏览器，以保持最佳兼容性；
3. 单纯的恢复出厂设置并不能完全清除jffs分区的软件中心文件，需要在恢复出厂设置的时候同时勾选恢复按钮旁边的选择框；


### 八、重要命令

> 以下操作需要使用支持SSH协议的软件，连接到路由器后台进行操作，如果不会使用，可以参考下面步骤：
>
> 1. **启用SSH：** 在路由器后台的【系统管理】-【系统设置】里，将【启用 SSH】更改为`LAN only`，将端口号设置为`22`或者其它数字，点击页面下方【应用本页面设置】保存更改；
> 2. **登录SSH：** 下载SSH软件，如putty（[官方绿色版putty 0.74下载地址](https://the.earth.li/~sgtatham/putty/0.74/w64/putty.exe)），运行后在Host Name（or IP address）处输入路由器的局域网IP地址，如：`192.168.50.1`或者`router.asus.com`，端口为上一步中【SSH 端口】中的端口，如果没有更改，则为`22`，点击【Open】，如果有弹出Putty Security Alert，点击【是】；在界面的`login as`后面输入`路由器的登录帐号`后回车，然后在 password: 提示符后输入`路由器登录密码`后回车（记住：输入密码的时候不会有任何显示，输入完成后直接回车即可），完成登录。
> 3. **键入命令：** 键入命令时建议将系统输入法切换为英文，也可以复制命令后使用右键即可粘贴命令，粘贴完毕后按回车即可执行命令。

#### 1. 软件中心重置

- 开启路由器SSH功能后，通过putty、xshell等SSH软件连接路由器，直接在ssh客户端内运行下面的程序即可。

```bash
koolshare-reset
```

#### 2. 清空JFFS空间

- 注意，此操作会删除jffs分区内的所有文件，包括但不限于：软件中心、安装的证书、TrafficAnalyzer的数据库、自定义的设备图标等

```bash
kill -9 $(pidof skipd)
cd /jffs && rm -r .[a-zA-Z_]* *
reboot
```

#### 3. 删除软件中心

- 适用于**官改固件**刷回**原厂固件**，需要删除留在jffs分区内软件中心，而不删除其它文件；
- 如果是在**官改固件**下删除软件中心，路由器重启后软件中心会重新初始化为最初状态。

```bash
kill -9 $(pidof skipd)
cd /jffs
rm -rf .asusrouter .koolshare db ksdb config/* etc/profile scripts/*
reboot
```

#### 4. 重启软件中心

- 当软件中心相关进程挂掉的时候，此时可以用ssh进入路由器后台，输入以下命令重启软件中心：

```bash
sh /koolshare/perp/perp.sh
```

#### 5. GT-AX6000查询坏块命令

- 504axhnd.675x平台查询坏块的命令如下（运行以下命令，返回数字即为坏块数量）：
- GT-AX6000查询坏块已经毫无意义，因为该平台机器采用了全UBIFS分区格式，这意味着即使有一定坏块也不会影响系统

```bash
cat /sys/class/mtd/mtd0/bad_blocks
```
